<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Clientes - SGL Pro</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --light-bg:#ecf0f1;
      --card-radius:1rem;
    }
    body{background:var(--light-bg); font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; color:#222; margin:0;}
    .wrapper{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--primary);color:#fff;padding:1rem;position:fixed;height:100%;overflow:auto}
    .main{margin-left:260px;padding:1.25rem;width:100%}
    .sidebar .brand{font-weight:700;font-size:1.2rem;margin-bottom:1rem}
    .sidebar a{display:block;color:rgba(255,255,255,.85);padding:.6rem;border-radius:.5rem;text-decoration:none}
    .sidebar a.active, .sidebar a:hover{background:var(--secondary);color:#fff}
    @media(max-width:768px){.sidebar{position:fixed;left:-280px;transition:all .25s} .sidebar.open{left:0} .main{margin-left:0} .toggler{display:inline-block}}
    .card-custom{border-radius:var(--card-radius);box-shadow:0 8px 30px rgba(0,0,0,0.06);overflow:hidden}
    .card-header-custom{background:var(--primary);color:#fff;padding:.9rem 1.25rem;font-weight:600}
    .stat{padding:1rem;border-radius:.8rem;color:#fff;text-align:center}
    .bg-blue{background:linear-gradient(45deg,#3498db,#2980b9)}
    .bg-green{background:linear-gradient(45deg,#2ecc71,#27ae60)}
    .bg-purple{background:linear-gradient(45deg,#9b59b6,#8e44ad)}
    .table-custom th{background:var(--primary);color:#fff}
    .alert-fixed{position:fixed;top:1rem;right:1rem;z-index:2000;min-width:260px}
    .btn-small{padding:.35rem .6rem;font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrapper">
    <nav id="sidebar" class="sidebar">
      <div class="brand">SGL Clientes</div>
      <div class="mb-3 text-white-50">Bienvenido, <strong id="clientNameTitle">Cliente</strong></div>
      <a href="#" class="active" data-section="dashboard"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
      <a href="#" data-section="loans"><i class="fas fa-coins me-2"></i> Mis Préstamos</a>
      <a href="#" data-section="contracts"><i class="fas fa-file-contract me-2"></i> Contratos / Paz y Salvo</a>
      <a href="#" data-section="profile"><i class="fas fa-user-circle me-2"></i> Mi Perfil</a>
      <div style="position:absolute;bottom:1rem;left:1rem">
        <a href="login.html" id="logoutBtn" class="text-white-50"><i class="fas fa-sign-out-alt me-1"></i> Cerrar sesión</a>
      </div>
    </nav>

    <main class="main">
      <button id="toggler" class="btn btn-light toggler mb-3 d-none"><i class="fas fa-bars"></i></button>
      <h2 class="mb-3">Hola, <span id="clientNameHeadline">Cliente</span></h2>

      <div id="alertPlaceholder"></div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="section active">
        <div class="row g-3 mb-4">
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat bg-blue card-custom">
              <div><small>Saldo Pendiente Total</small></div>
              <div class="h3 mt-2" id="totalPendingAmount">$0</div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat bg-green card-custom">
              <div><small>Préstamos Activos</small></div>
              <div class="h3 mt-2" id="activeLoansCount">0</div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat bg-purple card-custom">
              <div><small>Préstamos Finalizados</small></div>
              <div class="h3 mt-2" id="finalizedLoansCount">0</div>
            </div>
          </div>
        </div>

        <div class="card card-custom mb-4">
          <div class="card-header-custom">Actividad reciente</div>
          <div class="card-body">
            <div id="recentActivityContainer">
              <p class="text-muted">Cargando actividad...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- LOANS -->
      <section id="loans" class="section" style="display:none">
        <div class="card card-custom mb-4">
          <div class="card-header-custom"><i class="fas fa-list me-2"></i> Mis Préstamos</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-custom">
                <thead>
                  <tr><th>ID</th><th>Monto</th><th>Saldo</th><th>Cuotas</th><th>Estado</th><th>Acciones</th></tr>
                </thead>
                <tbody id="loansTableBody">
                  <tr><td colspan="6" class="text-center text-muted">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTRACTS -->
      <section id="contracts" class="section" style="display:none">
        <div class="card card-custom mb-4">
          <div class="card-header-custom"><i class="fas fa-file-contract me-2"></i> Contratos y Paz y Salvo</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-custom">
                <thead><tr><th>ID</th><th>Préstamo</th><th>Fecha</th><th>Tipo</th><th>Acciones</th></tr></thead>
                <tbody id="contractsTableBody">
                  <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="section" style="display:none">
        <div class="card card-custom mb-4">
          <div class="card-header-custom"><i class="fas fa-user-circle me-2"></i> Mi Perfil</div>
          <div class="card-body">
            <form id="profileForm">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Documento (no editable)</label>
                  <input id="profileDoc" class="form-control" readonly>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Nombre completo</label>
                  <input id="profileName" class="form-control" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Teléfono</label>
                  <input id="profilePhone" class="form-control" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Dirección</label>
                  <input id="profileAddress" class="form-control">
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Color favorito (pregunta seguridad)</label>
                  <input id="profileColor" class="form-control">
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Animal favorito (pregunta seguridad)</label>
                  <input id="profileAnimal" class="form-control">
                </div>
                <div class="col-12 text-end">
                  <button type="submit" class="btn btn-primary btn-custom"><i class="fas fa-save me-2"></i> Guardar cambios</button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="card card-custom mb-4">
          <div class="card-header-custom"><i class="fas fa-key me-2"></i> Cambiar Contraseña</div>
          <div class="card-body">
            <form id="changePasswordForm">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label">Contraseña actual</label>
                  <input id="oldPassword" type="password" class="form-control" required>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Nueva contraseña</label>
                  <input id="newPassword" type="password" class="form-control" required>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Confirmar</label>
                  <input id="confirmPassword" type="password" class="form-control" required>
                </div>
                <div class="col-12 text-end">
                  <button class="btn btn-primary btn-custom" type="submit"><i class="fas fa-key me-2"></i> Cambiar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Loan details modal -->
  <div class="modal fade" id="loanModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Préstamo <span id="loanModalId"></span></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-6"><strong>Monto:</strong> <span id="modalLoanAmount"></span></div>
            <div class="col-6"><strong>Saldo:</strong> <span id="modalLoanBalance"></span></div>
            <div class="col-6"><strong>Cuotas:</strong> <span id="modalLoanCuotas"></span></div>
            <div class="col-6"><strong>Estado:</strong> <span id="modalLoanEstado"></span></div>
          </div>
          <h6>Plan de pagos</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>#</th><th>Vencimiento</th><th>Total</th><th>Capital</th><th>Interés</th><th>Estado</th></tr></thead>
              <tbody id="modalPaymentsBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button id="downloadContractBtn" class="btn btn-primary"><i class="fas fa-file-pdf me-2"></i> Descargar Contrato</button>
          <button id="downloadPazSalvoBtn" class="btn btn-success" style="display:none"><i class="fas fa-file-export me-2"></i> Descargar Paz y Salvo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  // ---------- CONFIG ----------
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxCILJhPhwUWLdc1ws6THP2UUkL7z8SwJbl5yPU6Lc6yRXoJcBmqqyofI9MCKjNfBFygg/exec'; // <-- reemplaza
  const sessionToken = localStorage.getItem('sessionToken');
  const username = localStorage.getItem('username');

  // ---------- BOOTSTRAP / UI helpers ----------
  function showAlert(msg, type='info') {
    const ph = document.getElementById('alertPlaceholder');
    const wrapper = document.createElement('div');
    wrapper.className = 'alert alert-' + type + ' alert-fixed';
    wrapper.innerHTML = `<div><strong>${msg}</strong></div>`;
    ph.appendChild(wrapper);
    setTimeout(()=> wrapper.remove(), 5000);
  }

  function toggleSidebar(open) {
    const sb = document.getElementById('sidebar');
    if(open) sb.classList.add('open'); else sb.classList.remove('open');
  }

  // ---------- NETWORK ----------
  async function makeRequest(action, data = {}) {
    try {
      const payload = { ...data, action, sessionToken };
      const form = new FormData();
      form.append('payload', JSON.stringify(payload));
      const resp = await fetch(BACKEND_URL, { method:'POST', body: form });
      const result = await resp.json();
      return result;
    } catch (e) {
      console.error('Request error', e);
      return { success:false, message:'Error de conexión' };
    }
  }

  // ---------- BOOT / NAV ----------
  document.addEventListener('DOMContentLoaded', async () => {
    if (!sessionToken || !username) {
      window.location.href = '/';
      return;
    }
    // responsive toggler
    const toggler = document.getElementById('toggler');
    toggler.addEventListener('click', ()=> toggleSidebar(true));
    document.querySelectorAll('.sidebar a').forEach(a=>{
      a.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        document.querySelectorAll('.section').forEach(s => s.style.display='none');
        const sec = a.getAttribute('data-section') || 'dashboard';
        document.getElementById(sec).style.display = 'block';
        document.querySelectorAll('.sidebar a').forEach(x=>x.classList.remove('active'));
        a.classList.add('active');

        // load data per section
        if (sec === 'dashboard') await loadDashboard();
        if (sec === 'loans') await loadLoans();
        if (sec === 'contracts') await loadContracts();
        if (sec === 'profile') await loadProfile();
        // close sidebar on mobile
        if (window.innerWidth <= 768) toggleSidebar(false);
      });
    });

    // initial load
    document.getElementById('clientNameTitle').textContent = username;
    document.getElementById('clientNameHeadline').textContent = username;
    await loadDashboard();
    // setup forms
    document.getElementById('profileForm').addEventListener('submit', saveProfile);
    document.getElementById('changePasswordForm').addEventListener('submit', changePassword);
    
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
  await logout();
});
    // download contract / paz y salvo
    document.getElementById('downloadContractBtn').addEventListener('click', downloadCurrentContractPDF);
    document.getElementById('downloadPazSalvoBtn').addEventListener('click', downloadCurrentPazSalvoPDF);
  });

  // ---------- DASHBOARD ----------
  async function loadDashboard(){
    // load client info, loans summary and recent activity
    const infoResp = await makeRequest('getClientInfo', { username });
    const loansResp = await makeRequest('getClientLoans', { username });
    const paymentsResp = await makeRequest('getClientPayments', { clientId: username });

    if (infoResp.success) {
      const client = infoResp.data.client;
      document.getElementById('clientNameTitle').textContent = client.name.split(' ')[0] || client.name;
      document.getElementById('clientNameHeadline').textContent = client.name || username;
    }

    if (loansResp.success) {
      const loans = loansResp.data.loans || [];
      const totalPending = loans.filter(l => l.status === 'activo').reduce((s,l)=> s + (Number(l.currentBalance)||0),0);
      const activeCount = loans.filter(l => l.status === 'activo').length;
      const finalized = loans.filter(l => l.status !== 'activo').length;
      document.getElementById('totalPendingAmount').textContent = formatMoney(totalPending);
      document.getElementById('activeLoansCount').textContent = activeCount;
      document.getElementById('finalizedLoansCount').textContent = finalized;

      // recent activity: show last payments (from paymentsResp) or loan events
      const container = document.getElementById('recentActivityContainer');
      container.innerHTML = '';
      const payments = paymentsResp.success ? (paymentsResp.data.payments || []) : [];
      const recent = payments.slice(-6).reverse();
      if (recent.length === 0) container.innerHTML = '<p class="text-muted">No hay actividad reciente.</p>';
      else {
        const ul = document.createElement('ul'); ul.className='list-group';
        recent.forEach(p=>{
          const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-start';
          li.innerHTML = `<div><strong>Pago</strong> - Préstamo ${p[1]}<div class="text-muted small">${new Date(p[2]).toLocaleString()}</div></div><div class="fw-bold">${formatMoney(Number(p[4]||0))}</div>`;
          ul.appendChild(li);
        });
        container.appendChild(ul);
      }
    }
  }

  // ---------- LOANS ----------
  async function loadLoans(){
    const resp = await makeRequest('getClientLoans', { username });
    const tbody = document.getElementById('loansTableBody');
    tbody.innerHTML = '';
    if (!resp.success || !Array.isArray(resp.data.loans) || resp.data.loans.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No tienes préstamos registrados.</td></tr>';
      return;
    }
    resp.data.loans.forEach(loan => {
      const tr = document.createElement('tr');
      const paid = Number(loan.paidInstallments || 0);
      const total = Number(loan.totalInstallments || 0);
      tr.innerHTML = `
        <td>${loan.id}</td>
        <td>${formatMoney(Number(loan.amount)||0)}</td>
        <td>${formatMoney(Number(loan.currentBalance)||0)}</td>
        <td>${paid} / ${total}</td>
        <td>${loan.status === 'activo' ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-secondary">Finalizado</span>'}</td>
        <td>
          <button class="btn btn-sm btn-primary btn-small view-loan" data-loan='${encodeURIComponent(JSON.stringify(loan))}'>
            <i class="fas fa-eye me-1"></i> Ver
          </button>
        </td>`;
      tbody.appendChild(tr);
    });

    // attach listeners
    document.querySelectorAll('.view-loan').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const loan = JSON.parse(decodeURIComponent(e.currentTarget.getAttribute('data-loan')));
        openLoanModal(loan);
      });
    });
  }

  // open modal and populate
  let CURRENT_MODAL_CONTRACT = null;
  async function openLoanModal(loan){
    CURRENT_MODAL_CONTRACT = null;
    document.getElementById('loanModalId').textContent = loan.id;
    document.getElementById('modalLoanAmount').textContent = formatMoney(Number(loan.amount)||0);
    document.getElementById('modalLoanBalance').textContent = formatMoney(Number(loan.currentBalance)||0);
    document.getElementById('modalLoanCuotas').textContent = `${loan.paidInstallments||0} / ${loan.totalInstallments||0}`;
    document.getElementById('modalLoanEstado').textContent = loan.status === 'activo' ? 'Activo' : 'Finalizado';
    const tbody = document.getElementById('modalPaymentsBody'); tbody.innerHTML = '';

    // payments might be array of objects or array-of-arrays depending on backend -> normalize
    const payments = loan.payments || [];
    if (!Array.isArray(payments) || payments.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay pagos registrados.</td></tr>';
    } else {
      payments.forEach(p=>{
        // support object or array
        let cuota = p.cuotaNumber ?? (p[5] ?? '');
        let due = p.dueDate ?? (p[2] ?? '');
        let total = p.amount ?? (p[4] ?? 0);
        let capital = p.capital ?? (p[3] ?? 0);
        let interest = p.interest ?? (p[4] ?? 0);
        let status = (p.status ?? (p[5] ?? 'pendiente'));
        tbody.insertAdjacentHTML('beforeend', `<tr>
          <td>${cuota}</td>
          <td>${new Date(due).toLocaleDateString()}</td>
          <td>${formatMoney(Number(total)||0)}</td>
          <td>${formatMoney(Number(capital)||0)}</td>
          <td>${formatMoney(Number(interest)||0)}</td>
          <td>${status === 'pagada' ? '<span class="badge bg-success">Pagada</span>' : '<span class="badge bg-warning">Pendiente</span>'}</td>
        </tr>`);
      });
    }

    // Try to load contract info for this loan
    const cResp = await makeRequest('getClientContracts', { username });
    if (cResp.success && Array.isArray(cResp.data.contracts)) {
      // find contract for this loan
      const found = cResp.data.contracts.find(c => String(c.loanId) === String(loan.id));
      if (found) {
        CURRENT_MODAL_CONTRACT = found;
        document.getElementById('downloadContractBtn').disabled = false;
        document.getElementById('downloadPazSalvoBtn').style.display = found.pazSalvo ? 'inline-block' : 'none';
      } else {
        document.getElementById('downloadContractBtn').disabled = true;
        document.getElementById('downloadPazSalvoBtn').style.display = 'none';
      }
    } else {
      document.getElementById('downloadContractBtn').disabled = true;
      document.getElementById('downloadPazSalvoBtn').style.display = 'none';
    }

    const modal = new bootstrap.Modal(document.getElementById('loanModal'));
    modal.show();
  }

  // ---------- CONTRACTS ----------
  async function loadContracts(){
    const resp = await makeRequest('getClientContracts', { username });
    const tbody = document.getElementById('contractsTableBody');
    tbody.innerHTML = '';
    if (!resp.success || !Array.isArray(resp.data.contracts) || resp.data.contracts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay contratos registrados.</td></tr>';
      return;
    }
    resp.data.contracts.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.id}</td><td>${c.loanId||''}</td><td>${new Date(c.date).toLocaleDateString()}</td><td>${c.type||'Contrato'}</td>
        <td>
          <button class="btn btn-sm btn-primary btn-small view-contract" data-contract='${encodeURIComponent(JSON.stringify(c))}'>
            <i class="fas fa-eye me-1"></i> Ver / Descargar
          </button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.view-contract').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const c = JSON.parse(decodeURIComponent(e.currentTarget.getAttribute('data-contract')));
        CURRENT_MODAL_CONTRACT = c;
        // open a simple modal using loan modal fields
        document.getElementById('loanModalId').textContent = c.loanId || 'Contrato';
        document.getElementById('modalLoanAmount').textContent = c.amount ? formatMoney(Number(c.amount)) : '';
        document.getElementById('modalLoanBalance').textContent = c.pazSalvo ? 'Paz y Salvo' : '';
        document.getElementById('modalLoanCuotas').textContent = '';
        document.getElementById('modalLoanEstado').textContent = '';
        document.getElementById('modalPaymentsBody').innerHTML = `<tr><td colspan="6">${c.text || ''}</td></tr>`;
        document.getElementById('downloadContractBtn').disabled = false;
        document.getElementById('downloadPazSalvoBtn').style.display = c.pazSalvo ? 'inline-block' : 'none';
        const modal = new bootstrap.Modal(document.getElementById('loanModal'));
        modal.show();
      });
    });
  }

  // ---------- PROFILE ----------
  async function loadProfile(){
    const resp = await makeRequest('getClientInfo', { username });
    if (!resp.success) { showAlert(resp.message||'No se pudo cargar perfil','danger'); return; }
    const c = resp.data.client;
    document.getElementById('profileDoc').value = c.doc || username;
    document.getElementById('profileName').value = c.name || '';
    document.getElementById('profilePhone').value = c.phone || '';
    document.getElementById('profileAddress').value = c.address || '';
    document.getElementById('profileColor').value = c.favoriteColor || '';
    document.getElementById('profileAnimal').value = c.favoriteAnimal || '';
  }

  async function saveProfile(e){
    e.preventDefault();
    const payload = {
      username,
      name: document.getElementById('profileName').value.trim(),
      phone: document.getElementById('profilePhone').value.trim(),
      address: document.getElementById('profileAddress').value.trim(),
      favoriteColor: document.getElementById('profileColor').value.trim(),
      favoriteAnimal: document.getElementById('profileAnimal').value.trim()
    };
    const resp = await makeRequest('updateClientInfo', payload);
    if (resp.success) { showAlert('Perfil actualizado','success'); await loadProfile(); }
    else showAlert(resp.message || 'Error al guardar','danger');
  }

  async function changePassword(e){
    e.preventDefault();
    const oldP = document.getElementById('oldPassword').value;
    const newP = document.getElementById('newPassword').value;
    const conf = document.getElementById('confirmPassword').value;
    if (newP !== conf) { showAlert('Las contraseñas no coinciden','warning'); return; }
    const resp = await makeRequest('changePassword', { username, oldPassword: oldP, newPassword: newP });
    if (resp.success) { showAlert('Contraseña cambiada','success'); document.getElementById('changePasswordForm').reset(); }
    else showAlert(resp.message||'Error','danger');
  }

  // ---------- DOWNLOAD ----------
  async function downloadCurrentContractPDF(){
    if (!CURRENT_MODAL_CONTRACT) { showAlert('No hay contrato seleccionado','warning'); return; }
    // create a minimal html layout
    const html = `
      <div style="font-family:Arial;padding:24px">
        <h2 style="text-align:center">CONTRATO</h2>
        <p><strong>ID:</strong> ${CURRENT_MODAL_CONTRACT.id || ''}</p>
        <p><strong>Préstamo:</strong> ${CURRENT_MODAL_CONTRACT.loanId || ''}</p>
        <p><strong>Cliente:</strong> ${CURRENT_MODAL_CONTRACT.clientName || ''}</p>
        <p><strong>Fecha:</strong> ${new Date(CURRENT_MODAL_CONTRACT.date).toLocaleDateString()}</p>
        <hr/>
        <div>${CURRENT_MODAL_CONTRACT.text || ''}</div>
      </div>`;
    const blob = await htmlToPdfBlob(html, 0.98);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `contrato_${CURRENT_MODAL_CONTRACT.id||Date.now()}.pdf`; a.click();
    URL.revokeObjectURL(url);
  }

  async function downloadCurrentPazSalvoPDF(){
    if (!CURRENT_MODAL_CONTRACT || !CURRENT_MODAL_CONTRACT.pazSalvo) { showAlert('No hay paz y salvo','warning'); return; }
    const html = `<div style="font-family:Arial;padding:24px">
      <h2 style="text-align:center">PAZ Y SALVO</h2>
      <p><strong>ID:</strong> ${CURRENT_MODAL_CONTRACT.id || ''}</p>
      <p><strong>Préstamo:</strong> ${CURRENT_MODAL_CONTRACT.loanId || ''}</p>
      <p><strong>Cliente:</strong> ${CURRENT_MODAL_CONTRACT.clientName || ''}</p>
      <p><strong>Fecha emisión:</strong> ${new Date(CURRENT_MODAL_CONTRACT.pazSalvo.date).toLocaleDateString()}</p>
      <hr/>
      <p>${CURRENT_MODAL_CONTRACT.pazSalvo.text || 'Documento de paz y salvo'}</p>
    </div>`;
    const blob = await htmlToPdfBlob(html, 0.98);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `pazsalvo_${CURRENT_MODAL_CONTRACT.id||Date.now()}.pdf`; a.click();
    URL.revokeObjectURL(url);
  }

  async function htmlToPdfBlob(htmlContent, scale=1){
    const wrap = document.createElement('div');
    wrap.innerHTML = htmlContent;
    document.body.appendChild(wrap);
    const canvas = await html2canvas(wrap, { scale: scale });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    const blob = pdf.output('blob');
    document.body.removeChild(wrap);
    return blob;
  }

  // ---------- UTIL ----------
  function formatMoney(v){ return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(Number(v||0)); }

  // ---------- LOGOUT ----------
  async function logout(){
    await makeRequest('logout', { sessionToken });
    localStorage.removeItem('sessionToken'); localStorage.removeItem('username');
    window.location.href = '/';
  }

  </script>
</body>
</html>

